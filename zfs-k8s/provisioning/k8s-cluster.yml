---
- name: Apply k8s control plane
  hosts: k8s_cp
  become: true # This applies to all tasks in this play
  serial: 1
  vars:
    kubernetes_version: "1.34"
    cni: "flannel"
    ansible_user: vagrant
    containerd_config_cgroup_driver_systemd: true
  pre_tasks:
    - name: Disable swap immediately
      command: swapoff -a
      when: ansible_swaptotal_mb | int > 0
    - name: Remove any swap entries from /etc/fstab
      replace:
        path: /etc/fstab
        regexp: '^\s*(.+\s+)swap(\s+.+)$'
        replace: '# \1swap\2'
      become: true

  roles:
    #- hwwilliams.zfs
    - geerlingguy.ntp
    - geerlingguy.containerd
    - geerlingguy.kubernetes

- name: Apply k8s nodes
  serial: 1
  hosts: k8s_nodes
  become: true
  vars:
    ansible_user: vagrant
    kubernetes_version: "1.34"
    containerd_config_cgroup_driver_systemd: true
  pre_tasks:
    - name: Disable swap immediately
      command: swapoff -a
      when: ansible_swaptotal_mb | int > 0
    - name: Remove any swap entries from /etc/fstab
      replace:
        path: /etc/fstab
        regexp: '^\s*(.+\s+)swap(\s+.+)$'
        replace: '# \1swap\2'
  roles:
    - geerlingguy.ntp
    - geerlingguy.containerd
    - geerlingguy.kubernetes
